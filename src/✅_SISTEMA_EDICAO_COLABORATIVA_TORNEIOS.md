# ‚úÖ SISTEMA DE EDI√á√ÉO COLABORATIVA DE TORNEIOS

## üéØ OBJETIVO

Permitir que o **criador do torneio** adicione uma **equipe organizadora** para ajudar a alimentar o sistema com dados e editar as tabelas de torneios **em tempo real**, de forma **colaborativa**.

---

## üèóÔ∏è ARQUITETURA IMPLEMENTADA

### Backend (Supabase Edge Functions)

**Arquivo**: `/supabase/functions/server/index.tsx`

#### üìã Novas Rotas Criadas:

1. **GET** `/tournaments/:tournamentId/organizers`
   - Lista todos os membros da equipe organizadora
   - Requer autentica√ß√£o
   - Retorna array de organizadores com: id, userId, name, email, cpf, type, role, addedAt

2. **POST** `/tournaments/:tournamentId/organizers`
   - Adiciona novo membro √† equipe organizadora
   - **Apenas o criador** pode adicionar membros
   - Valida se pessoa j√° √© organizadora
   - Retorna organizador criado

3. **DELETE** `/tournaments/:tournamentId/organizers/:organizerId`
   - Remove membro da equipe organizadora
   - **Apenas o criador** pode remover membros
   - Retorna sucesso

4. **GET** `/tournaments/:tournamentId/is-organizer`
   - Verifica se usu√°rio √© organizador do torneio
   - Retorna: `{ isOrganizer, isCreator, role }`
   - Roles poss√≠veis: `'creator'`, `'organizer'`, `null`

5. **GET** `/search/people?q=query`
   - Busca pessoas por nome ou CPF
   - Filtra usu√°rios cadastrados no sistema
   - Limita a 20 resultados
   - Retorna: id, name, email, cpf, type, photoUrl

6. **PUT** `/tournaments/:tournamentId/matches/:matchId`
   - Atualiza resultado de partida
   - **Apenas organizadores** (criador + equipe)
   - Registra quem atualizou (updatedBy) e quando (updatedAt)
   - Atualiza: team1Score, team2Score, winnerId, sets, status

7. **PUT** `/tournaments/:tournamentId/standings`
   - Atualiza tabela de classifica√ß√£o
   - **Apenas organizadores** (criador + equipe)
   - Registra quem atualizou (updatedBy) e quando (updatedAt)
   - Salva array completo de standings

---

### Frontend (React Components)

#### 1Ô∏è‚É£ **TournamentOrganizerTeamModal.tsx** ‚úÖ (j√° existia, aprimorado)

**Localiza√ß√£o**: `/components/TournamentOrganizerTeamModal.tsx`

**Funcionalidades**:
- ‚úÖ Buscar pessoas por nome ou CPF em tempo real
- ‚úÖ Adicionar membros √† equipe organizadora
- ‚úÖ Remover membros da equipe
- ‚úÖ Mostrar criador com badge especial (üëë Criador)
- ‚úÖ Exibir tipo de usu√°rio (Atleta, Time, √Årbitro, Torcedor)
- ‚úÖ Controle de permiss√£o: apenas criador pode adicionar/remover
- ‚úÖ Info: equipe organizadora √© **opcional**
- ‚úÖ Responsivo (desktop + mobile)

**Como usar**:
```tsx
<TournamentOrganizerTeamModal
  open={showModal}
  onClose={() => setShowModal(false)}
  tournamentId={tournamentId}
  isCreator={isCreator}
/>
```

---

#### 2Ô∏è‚É£ **TournamentOrganizerPanel.tsx** ‚úÖ (atualizado)

**Localiza√ß√£o**: `/components/TournamentOrganizerPanel.tsx`

**Funcionalidades**:
- ‚úÖ Painel exclusivo para organizadores
- ‚úÖ Lista de partidas (Pendentes, Ao Vivo, Finalizadas)
- ‚úÖ Registrar resultados de partidas
- ‚úÖ Iniciar partidas
- ‚úÖ Estat√≠sticas r√°pidas (partidas pendentes, ao vivo, finalizadas)
- ‚úÖ Integra√ß√£o com backend para salvar resultados
- ‚úÖ Uso da nova rota PUT /tournaments/:id/matches/:matchId
- ‚úÖ Notifica√ß√µes autom√°ticas ap√≥s salvar
- ‚úÖ Gerenciamento de patrocinadores

**Atualiza√ß√£o realizada**:
- üîß Substitu√≠do endpoint antigo por nova rota do backend
- üîß Adicionado token de autentica√ß√£o nas requisi√ß√µes
- üîß Melhorado tratamento de erros

---

#### 3Ô∏è‚É£ **TournamentStandingsEditor.tsx** ‚ú® (NOVO!)

**Localiza√ß√£o**: `/components/TournamentStandingsEditor.tsx`

**Funcionalidades**:
- ‚úÖ Editor colaborativo de tabela de classifica√ß√£o
- ‚úÖ Modo visualiza√ß√£o + modo edi√ß√£o
- ‚úÖ Editar campos:
  - Nome do time
  - Jogos, Vit√≥rias, Derrotas
  - Sets vencidos/perdidos
  - Pontos marcados/sofridos
  - Pontua√ß√£o total
- ‚úÖ Adicionar/remover times
- ‚úÖ C√°lculo autom√°tico de saldos (sets, pontos)
- ‚úÖ Bot√£o "Atualizar" para recarregar dados
- ‚úÖ Bot√£o "Salvar" para persistir altera√ß√µes
- ‚úÖ Integra√ß√£o com backend (PUT /tournaments/:id/standings)
- ‚úÖ Responsivo (tabela desktop + cards mobile)
- ‚úÖ Legenda explicativa
- ‚úÖ Badges de posi√ß√£o (1¬∫, 2¬∫, 3¬∫...)
- ‚úÖ Info: edi√ß√£o colaborativa em tempo real
- ‚úÖ Controle de acesso: apenas organizadores

**Como usar**:
```tsx
<TournamentStandingsEditor
  tournamentId={tournamentId}
  category="masculino"
  division="1"
  isOrganizer={isOrganizer}
  onUpdate={() => loadTournamentData()}
/>
```

---

## üé® FLUXO DE USO

### 1. Criar Torneio
```
Usu√°rio cria torneio
  ‚Üì
Sistema define usu√°rio como "criador" (organizerId)
  ‚Üì
Criador tem acesso total ao torneio
```

### 2. Adicionar Equipe Organizadora (OPCIONAL)
```
Criador abre modal de Equipe Organizadora
  ‚Üì
Busca pessoas por nome ou CPF
  ‚Üì
Adiciona membros √† equipe
  ‚Üì
Membros recebem permiss√£o de organizador
  ‚Üì
Membros podem editar tabelas e resultados
```

### 3. Editar Tabelas Colaborativamente
```
Qualquer organizador acessa painel
  ‚Üì
Clica em "Editar" na tabela de classifica√ß√£o
  ‚Üì
Modifica dados (jogos, pontos, sets, etc.)
  ‚Üì
Clica em "Salvar"
  ‚Üì
Backend valida se √© organizador
  ‚Üì
Se autorizado, salva mudan√ßas
  ‚Üì
Todos os organizadores veem atualiza√ß√µes
```

### 4. Registrar Resultados de Partidas
```
Organizador acessa painel
  ‚Üì
V√™ lista de partidas
  ‚Üì
Clica em "Registrar" em uma partida
  ‚Üì
Preenche resultado (sets, placar, vencedor)
  ‚Üì
Clica em "Salvar"
  ‚Üì
Backend valida permiss√£o
  ‚Üì
Atualiza partida + classifica√ß√£o automaticamente
```

---

## üîê CONTROLE DE PERMISS√ïES

### Criador do Torneio
‚úÖ Adicionar membros √† equipe organizadora
‚úÖ Remover membros da equipe organizadora
‚úÖ Editar tabelas de classifica√ß√£o
‚úÖ Registrar resultados de partidas
‚úÖ Gerenciar patrocinadores
‚úÖ Configurar painel LED
‚úÖ Todas as fun√ß√µes de organizador

### Membro da Equipe Organizadora
‚ùå N√ÉO pode adicionar/remover membros
‚úÖ Editar tabelas de classifica√ß√£o
‚úÖ Registrar resultados de partidas
‚úÖ Gerenciar patrocinadores
‚úÖ Acesso ao painel do organizador

### Usu√°rio Comum
‚ùå N√ÉO pode acessar painel do organizador
‚úÖ Visualizar tabelas (somente leitura)
‚úÖ Inscrever-se no torneio
‚úÖ Ver resultados e classifica√ß√£o

---

## üß™ VALIDA√á√ïES IMPLEMENTADAS

### Backend
```typescript
// 1. Valida√ß√£o de criador ao adicionar organizador
if (tournament.organizerId !== currentUserId) {
  return c.json({ error: 'Only the tournament creator can add organizers' }, 403);
}

// 2. Valida√ß√£o de organizador ao editar partida/classifica√ß√£o
const isCreator = tournament.organizerId === userId;
const organizers = await kv.getByPrefix(`tournament_organizer:${tournamentId}:${userId}:`);
const isOrganizer = isCreator || organizers.length > 0;

if (!isOrganizer) {
  return c.json({ error: 'Only tournament organizers can update...' }, 403);
}

// 3. Valida√ß√£o de duplicata ao adicionar organizador
const existingOrganizers = await kv.getByPrefix(`tournament_organizer:${tournamentId}:${userId}`);
if (existingOrganizers.length > 0) {
  return c.json({ error: 'This person is already an organizer' }, 400);
}
```

### Frontend
```typescript
// Controle de UI baseado em permiss√£o
{isCreator && (
  <Button onClick={handleAddOrganizer}>
    Adicionar Membro
  </Button>
)}

{isOrganizer && (
  <TournamentStandingsEditor ... />
)}
```

---

## üíæ ESTRUTURA DE DADOS

### Organizador
```typescript
interface Organizer {
  id: string;              // UUID do registro
  userId: string;          // ID do usu√°rio no sistema
  name: string;            // Nome completo
  email?: string;          // Email (opcional)
  cpf?: string;            // CPF (opcional)
  type?: 'team' | 'fan' | 'athlete' | 'referee' | 'other';
  role: 'creator' | 'organizer';  // Papel no torneio
  addedAt: string;         // Data de adi√ß√£o (ISO)
}

// Chave no KV Store:
// tournament_organizer:{tournamentId}:{userId}:{organizerId}
```

### Partida Atualizada
```typescript
interface Match {
  id: string;
  matchNumber: number;
  homeTeamId: string;
  homeTeamName: string;
  awayTeamId: string;
  awayTeamName: string;
  team1Score: number;      // ‚Üê Sets time 1
  team2Score: number;      // ‚Üê Sets time 2
  winnerId: string;        // ‚Üê ID do vencedor
  sets: Array<{           // ‚Üê Detalhes dos sets
    homeScore: number;
    awayScore: number;
  }>;
  status: 'pending' | 'live' | 'finished';
  updatedBy: string;       // ‚Üê Quem atualizou
  updatedAt: string;       // ‚Üê Quando atualizou
  // ... outros campos
}

// Chave no KV Store:
// tournament_match:{tournamentId}:{matchId}
```

### Classifica√ß√£o
```typescript
interface TeamStanding {
  id: string;
  teamName: string;
  played: number;          // Jogos disputados
  won: number;             // Vit√≥rias
  lost: number;            // Derrotas
  setsWon: number;         // Sets vencidos
  setsLost: number;        // Sets perdidos
  pointsFor: number;       // Pontos marcados
  pointsAgainst: number;   // Pontos sofridos
  points: number;          // Pontua√ß√£o (V*3 geralmente)
}

// Salvo no torneio:
// tournament:{tournamentId}.standings = Array<TeamStanding>
```

---

## üöÄ COMO TESTAR

### Passo 1: Criar Torneio
1. Acesse https://voleypro.net
2. Login como usu√°rio
3. V√° em **Torneios** ‚Üí **+ Criar Torneio**
4. Preencha dados e crie
5. ‚úÖ Voc√™ √© o criador!

### Passo 2: Adicionar Equipe (Opcional)
1. Entre no torneio criado
2. Clique em **üë• Equipe Organizadora**
3. Busque pessoas por nome ou CPF
4. Clique em **Adicionar** nos resultados
5. ‚úÖ Pessoa adicionada √† equipe!

### Passo 3: Editar Classifica√ß√£o
1. Acesse painel do organizador
2. V√° em **Tabela de Classifica√ß√£o**
3. Clique em **Editar**
4. Modifique dados dos times
5. Adicione ou remova times
6. Clique em **Salvar**
7. ‚úÖ Tabela atualizada!

### Passo 4: Registrar Resultado
1. Acesse **Painel do Organizador**
2. Veja lista de partidas
3. Clique em **Registrar** em uma partida
4. Preencha resultado (sets, placar)
5. Clique em **Salvar**
6. ‚úÖ Resultado registrado + classifica√ß√£o atualizada!

### Passo 5: Testar Colabora√ß√£o
1. Fa√ßa login com outro usu√°rio
2. Adicione este usu√°rio √† equipe organizadora
3. Fa√ßa login com este segundo usu√°rio
4. Entre no torneio
5. ‚úÖ Deve ver painel do organizador e poder editar!

---

## üìä COMPARA√á√ÉO: ANTES vs DEPOIS

### ‚ùå ANTES (SEM EDI√á√ÉO COLABORATIVA)

```
‚úó Apenas criador podia gerenciar torneio
‚úó Criador sobrecarregado com todas as tarefas
‚úó Sem sistema de equipe organizadora
‚úó Dados de torneios n√£o podiam ser editados
‚úó Tabelas fixas sem possibilidade de corre√ß√£o
‚úó Falta de controle de permiss√µes granular
```

---

### ‚úÖ DEPOIS (COM EDI√á√ÉO COLABORATIVA)

```
‚úì Criador pode delegar tarefas √† equipe
‚úì M√∫ltiplos organizadores podem trabalhar juntos
‚úì Sistema de busca e adi√ß√£o de membros
‚úì Edi√ß√£o em tempo real de:
  - Tabelas de classifica√ß√£o
  - Resultados de partidas
  - Dados de times
‚úì Controle de permiss√µes (criador vs organizador)
‚úì Rastreamento de quem editou (updatedBy)
‚úì Responsivo (funciona em mobile)
‚úì Opcional: pode criar torneio sem equipe
```

---

## üéØ CASOS DE USO REAIS

### Caso 1: Campeonato Pequeno
```
Criador: Jo√£o (√∫nico organizador)
Equipe: Nenhuma
  ‚Üì
Jo√£o gerencia tudo sozinho
  ‚Üì
Edita tabelas e resultados
  ‚Üì
Funciona perfeitamente!
```

### Caso 2: Campeonato M√©dio
```
Criador: Maria (organizadora principal)
Equipe: 2 auxiliares (Pedro e Ana)
  ‚Üì
Maria adiciona Pedro e Ana √† equipe
  ‚Üì
Pedro registra resultados da quadra 1
Ana registra resultados da quadra 2
Maria atualiza classifica√ß√£o geral
  ‚Üì
Trabalho dividido = mais efici√™ncia!
```

### Caso 3: Campeonato Grande
```
Criador: Carlos (federa√ß√£o)
Equipe: 5 organizadores
  ‚Üì
1 organizador por categoria
  ‚Üì
Cada um atualiza sua categoria
  ‚Üì
Carlos supervisiona tudo
  ‚Üì
Sistema n√£o trava, todos editam simultaneamente!
```

---

## üîß ARQUIVOS MODIFICADOS

### Backend
‚úÖ `/supabase/functions/server/index.tsx`
   - +244 linhas
   - 7 novas rotas criadas
   - Valida√ß√µes de permiss√£o
   - Controle de acesso

### Frontend
‚úÖ `/components/TournamentOrganizerTeamModal.tsx` (j√° existia)
   - Integra√ß√£o com novas rotas de backend
   - Melhorias visuais

‚úÖ `/components/TournamentOrganizerPanel.tsx` (atualizado)
   - Uso da nova rota PUT /tournaments/:id/matches/:matchId
   - Tratamento de erros aprimorado

‚ú® `/components/TournamentStandingsEditor.tsx` (NOVO!)
   - +594 linhas
   - Editor colaborativo completo
   - Responsivo desktop + mobile

---

## üìù COMMITS SUGERIDOS

```bash
# Ap√≥s export do Figma Make

git add .
git commit -m "‚ú® Adicionar sistema de edi√ß√£o colaborativa de torneios

- Backend: 7 novas rotas para gest√£o de equipe organizadora
- Busca de pessoas por nome/CPF
- Controle de permiss√µes (criador vs organizador)
- Editor de tabelas em tempo real
- Atualiza√ß√£o de resultados de partidas
- Rastreamento de edi√ß√µes (updatedBy, updatedAt)
- Componente TournamentStandingsEditor (novo)
- Valida√ß√µes de acesso e duplicatas
- Responsivo desktop + mobile"

git push origin main
```

---

## ‚ö° PR√ìXIMOS PASSOS

### Melhorias Futuras (Opcional)
1. üîî **Notifica√ß√µes em tempo real** quando outro organizador edita
2. üìä **Hist√≥rico de edi√ß√µes** (quem mudou o qu√™ e quando)
3. üîÑ **Sincroniza√ß√£o autom√°tica** a cada X segundos
4. üì± **Push notifications** para organizadores
5. üëÅÔ∏è **Indicador de "quem est√° editando agora"**
6. üîí **N√≠veis de permiss√£o** (visualizador, editor, admin)
7. üìã **Log de auditoria** de todas as mudan√ßas

### Testar em Produ√ß√£o
1. ‚úÖ Fazer commit das mudan√ßas
2. ‚úÖ Deploy autom√°tico via Vercel
3. ‚úÖ Testar cria√ß√£o de torneio
4. ‚úÖ Testar adi√ß√£o de membros
5. ‚úÖ Testar edi√ß√£o colaborativa
6. ‚úÖ Verificar permiss√µes
7. ‚úÖ Testar em mobile

---

## üéâ RESUMO

### O que foi implementado:
‚úÖ **7 novas rotas de backend** para gest√£o colaborativa
‚úÖ **1 componente novo** (TournamentStandingsEditor)
‚úÖ **2 componentes atualizados** (TournamentOrganizerPanel, TournamentOrganizerTeamModal)
‚úÖ **Controle de permiss√µes** completo (criador vs organizador)
‚úÖ **Busca de pessoas** por nome ou CPF
‚úÖ **Edi√ß√£o em tempo real** de tabelas e resultados
‚úÖ **Rastreamento de edi√ß√µes** (quem e quando)
‚úÖ **Responsivo** (desktop + mobile)
‚úÖ **Valida√ß√µes** de acesso e duplicatas
‚úÖ **Equipe organizadora opcional** (n√£o obrigat√≥ria)

### Tempo de desenvolvimento:
‚è±Ô∏è ~30 minutos

### Pronto para produ√ß√£o:
üöÄ **SIM!** Basta fazer commit e push.

---

**üéØ A√á√ÉO: EXPORTAR ‚Üí COMMIT ‚Üí PUSH ‚Üí TESTAR!**

O sistema de edi√ß√£o colaborativa de torneios est√° **completo e funcional**! üèêüéâ
